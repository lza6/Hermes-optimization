{% extends "base.html" %}

{% block title %}控制中心 - Hermes v5.0{% endblock %}
{% block header_title %}运营智能控制台{% endblock %}
{% set active_page = "dashboard" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    .chart-container {
        height: 320px;
        width: 100%;
    }

    .stat-bg-glow {
        position: absolute;
        top: -20%;
        right: -10%;
        width: 150px;
        height: 150px;
        filter: blur(40px);
        opacity: 0.15;
        z-index: 0;
    }

    .provider-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 4px solid transparent;
    }

    .provider-card:hover {
        background: rgba(255, 255, 255, 0.9);
        border-left-color: #6366f1;
    }

    .dark .provider-card:hover {
        background: rgba(30, 41, 59, 0.9);
    }

    @keyframes pulse-ring {
        0% {
            transform: scale(0.33);
            opacity: 1;
        }

        80%,
        100% {
            opacity: 0;
        }
    }

    .status-pulse {
        position: relative;
        display: inline-flex;
    }

    .status-pulse::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: currentColor;
        animation: pulse-ring 1.2s cubic-bezier(0.45, 0, 0.9, 1) infinite;
    }
</style>
{% endblock %}

{% block content %}
<!-- 全局指标统计 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
    <div class="glass-v2 p-8 rounded-3xl relative overflow-hidden group">
        <div class="stat-bg-glow bg-blue-500"></div>
        <div class="relative z-10">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">总吞吐量</p>
            <h3 class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter" id="totalRequests">0</h3>
            <div
                class="flex items-center gap-2 mt-4 text-[10px] font-bold text-green-500 bg-green-500/10 px-2 py-1 rounded-lg w-fit">
                <i class="fa-solid fa-arrow-trend-up"></i>
                <span>实时流式传输中</span>
            </div>
        </div>
    </div>

    <div class="glass-v2 p-8 rounded-3xl relative overflow-hidden group">
        <div class="stat-bg-glow bg-indigo-500"></div>
        <div class="relative z-10">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">P90 延迟</p>
            <h3 class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter" id="p90Latency">0<span
                    class="text-lg ml-1 font-bold text-gray-400">ms</span></h3>
            <div class="mt-4 h-1.5 w-full bg-gray-100 dark:bg-slate-800 rounded-full overflow-hidden">
                <div id="latencyProgress" class="h-full bg-indigo-500 transition-all duration-1000" style="width: 0%">
                </div>
            </div>
        </div>
    </div>

    <div class="glass-v2 p-8 rounded-3xl relative overflow-hidden group">
        <div class="stat-bg-glow bg-purple-500"></div>
        <div class="relative z-10">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">活跃节点</p>
            <h3 class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter" id="activeNodes">0<span
                    class="text-lg ml-1 font-bold text-gray-400" id="totalNodes">/0</span></h3>
            <div class="flex items-center gap-1.5 mt-4">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                <span class="text-[10px] font-bold text-emerald-500 uppercase tracking-tighter">可用性: 100%</span>
            </div>
        </div>
    </div>

    <div class="glass-v2 p-8 rounded-3xl bg-indigo-600 border-indigo-500/20 group cursor-pointer hover:shadow-indigo-500/25 transition-all"
        onclick="document.getElementById('addProviderCard').scrollIntoView({behavior: 'smooth'})">
        <div class="relative z-10 flex flex-col justify-center h-full text-white">
            <div
                class="w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <i class="fa-solid fa-plus text-xl"></i>
            </div>
            <h3 class="text-xl font-bold tracking-tight">扩展矩阵</h3>
            <p class="text-xs text-indigo-100 mt-1">添加新的上游供应商</p>
        </div>
    </div>
</div>

<!-- 实时情报网格 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-10 mb-12">
    <!-- 延迟分布图 -->
    <div class="lg:col-span-2 glass-v2 rounded-[40px] p-10 border-white/40">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h4 class="text-xl font-black tracking-tight text-slate-800 dark:text-white">实时性能矩阵</h4>
                <p class="text-xs text-gray-400 font-medium">延迟趋势与吞吐量实时监控 (ms/req)</p>
            </div>
            <div class="flex gap-2">
                <div
                    class="px-3 py-1.5 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 text-[10px] font-bold text-slate-500 uppercase">
                    1分钟 窗口
                </div>
            </div>
        </div>
        <div id="latencyChart" class="chart-container"></div>
    </div>

    <!-- 实时异常日志 -->
    <div class="glass-v2 rounded-[40px] p-10 flex flex-col border-white/40 min-h-[400px]">
        <div class="mb-8">
            <h4 class="text-xl font-black tracking-tight text-slate-800 dark:text-white">异常检测</h4>
            <p class="text-xs text-gray-400 font-medium">最近的系统错误与警告</p>
        </div>
        <div id="errorFeed" class="flex-1 space-y-4 overflow-y-auto pr-2 custom-scrollbar">
            <div
                class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/30 text-center border border-dashed border-slate-200 dark:border-slate-700">
                <p class="text-xs text-slate-400 font-medium italic">当前会话未检测到异常</p>
            </div>
        </div>
    </div>
</div>

<!-- 供应商网格 -->
<div class="mb-20">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h4 class="text-3xl font-black tracking-tighter text-slate-800 dark:text-white">活跃节点矩阵</h4>
            <p class="text-sm text-slate-400 font-medium mt-1">纳管的 AI 服务供应商及其路由状态</p>
        </div>
        <button onclick="resyncAll()"
            class="px-6 py-2.5 rounded-2xl glass-v2 border-indigo-500/20 text-indigo-600 dark:text-indigo-400 text-xs font-bold hover:bg-indigo-50 transition-all flex items-center gap-2">
            <i class="fa-solid fa-sync"></i>
            <span>同步矩阵</span>
        </button>
    </div>
    <div id="providerGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div class="col-span-full py-20 text-center">
            <div
                class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-spin">
                <i class="fa-solid fa-cosmic-spin text-indigo-500"></i>
            </div>
            <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">正在初始化实时数据流...</p>
        </div>
    </div>
</div>

<!-- 添加供应商 -->
<div id="addProviderCard" class="glass-v2 rounded-[40px] p-12 max-w-4xl mx-auto border-indigo-500/10 shadow-2xl mb-20">
    <div class="text-center mb-10">
        <h2 class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter mb-2">连接新智能节点</h2>
        <p class="text-slate-400 font-medium">将 OpenAI 兼容的 API 端点接入矩阵</p>
    </div>

    <form id="addProviderForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="space-y-6">
            <div>
                <label
                    class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-2 block">供应商别名</label>
                <input type="text" id="name" placeholder="例如: DeepSeek-V3" required
                    class="w-full px-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-2 block">基础
                    URL</label>
                <input type="url" id="baseUrl" placeholder="https://api.deepseek.com/v1" required
                    class="w-full px-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-mono text-sm leading-none">
            </div>
        </div>
        <div class="space-y-6">
            <div>
                <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-2 block">API
                    密钥</label>
                <input type="password" id="apiKey" placeholder="sk-..." required
                    class="w-full px-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-mono text-sm leading-none">
            </div>
            <div>
                <label class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-2 block">模型黑名单
                    (逗号分隔)</label>
                <input type="text" id="modelBlacklist" placeholder="embedding-..."
                    class="w-full px-6 py-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold">
            </div>
        </div>
        <div class="md:col-span-2 pt-6">
            <button type="submit"
                class="w-full py-5 rounded-2xl bg-indigo-600 text-white font-black uppercase tracking-widest hover:bg-indigo-700 hover:shadow-2xl hover:shadow-indigo-500/30 transition-all flex items-center justify-center gap-3">
                <span>部署节点至矩阵</span>
                <i class="fa-solid fa-shuttle-space"></i>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const latencyHistory = [];
    const requestHistory = [];
    const labels = [];
    let chart = null;

    function initCharts() {
        const dom = document.getElementById('latencyChart');
        chart = echarts.init(dom, window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : null);
        const option = {
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis', backgroundColor: 'rgba(255,255,255,0.9)', borderRadius: 12, borderWidth: 0 },
            grid: { top: 40, left: 40, right: 20, bottom: 40 },
            xAxis: {
                type: 'category', data: labels, axisLine: { show: false }, axisTick: { show: false },
                axisLabel: { color: '#94a3b8', fontSize: 10 }
            },
            yAxis: [
                { type: 'value', name: '延迟 (ms)', splitLine: { lineStyle: { type: 'dashed', color: 'rgba(148,163,184,0.1)' } }, axisLabel: { color: '#94a3b8' } },
                { type: 'value', name: '每分钟请求数', splitLine: { show: false }, axisLabel: { color: '#94a3b8' } }
            ],
            series: [
                {
                    name: '平均延迟', type: 'line', smooth: true, data: latencyHistory, itemStyle: { color: '#6366f1' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(99, 102, 241, 0.3)' }, { offset: 1, color: 'rgba(99, 102, 241, 0)' }]) },
                    symbol: 'none'
                },
                {
                    name: '吞吐量', type: 'bar', yAxisIndex: 1, data: requestHistory,
                    itemStyle: { color: 'rgba(168, 85, 247, 0.4)', borderRadius: [4, 4, 0, 0] }
                }
            ]
        };
        chart.setOption(option);
    }

    function updateHeaderStats(data) {
        document.getElementById('totalRequests').innerText = data.counters.total_requests.toLocaleString();
        const p90 = data.latency.p90 || 0;
        document.getElementById('p90Latency').childNodes[0].nodeValue = p90;
        const progress = Math.min((p90 / 3000) * 100, 100);
        const pb = document.getElementById('latencyProgress');
        pb.style.width = `${progress}%`;
        pb.className = `h-full transition-all duration-1000 ${p90 > 2500 ? 'bg-red-500' : (p90 > 1200 ? 'bg-amber-500' : 'bg-indigo-500')}`;

        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        if (labels.length > 20) { labels.shift(); latencyHistory.shift(); requestHistory.shift(); }
        labels.push(timeStr);
        latencyHistory.push(p90);
        requestHistory.push(data.counters.total_requests);
        if (chart) {
            chart.setOption({ xAxis: { data: labels }, series: [{ data: latencyHistory }, { data: requestHistory }] });
        }
    }

    async function renderProviderGrid() {
        const grid = document.getElementById('providerGrid');
        try {
            const res = await fetch('/admin/providers');
            const { data } = await res.json();
            document.getElementById('totalNodes').innerText = `/${data.length}`;
            document.getElementById('activeNodes').innerText = data.filter(p => p.status === 'active').length;
            grid.innerHTML = '';
            if (data.length === 0) {
                grid.innerHTML = '<div class="col-span-full glass-v2 rounded-3xl p-12 text-center text-slate-400 font-bold border-dashed border-2">矩阵真空：尚未部署任何节点</div>';
                return;
            }
            data.forEach(p => {
                const card = document.createElement('div');
                card.className = 'glass-v2 p-8 rounded-[32px] provider-card flex flex-col relative group overflow-hidden';
                const statusLabels = { 'active': '活跃', 'syncing': '同步中', 'error': '故障', 'pending': '待定' };
                const statusStyles = { 'active': 'text-emerald-500 bg-emerald-500/10', 'syncing': 'text-indigo-500 bg-indigo-500/10 animate-pulse', 'error': 'text-red-500 bg-red-500/10', 'pending': 'text-slate-400 bg-slate-100' };
                const models = p.models ? p.models.slice(0, 3).map(m => `<span class="px-2 py-0.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-[9px] font-mono text-slate-500 border border-slate-200 dark:border-slate-700">${m}</span>`).join('') : '';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center shadow-lg group-hover:rotate-6 transition-transform">
                                <i class="fa-solid fa-server text-sm"></i>
                            </div>
                            <div>
                                <h5 class="font-black text-slate-800 dark:text-white tracking-tight leading-none">${p.name}</h5>
                                <p class="text-[9px] text-slate-400 font-mono mt-1.5 truncate max-w-[120px]">${p.baseUrl}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1.5">
                            <span class="px-2.5 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter flex items-center gap-1 ${statusStyles[p.status] || ''}">
                                <div class="w-1.5 h-1.5 rounded-full bg-current ${p.status === 'active' ? 'status-pulse' : ''}"></div>
                                ${statusLabels[p.status] || p.status}
                            </span>
                        </div>
                    </div>
                    <div class="flex-1 mt-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-3 rounded-2xl bg-slate-100/50 dark:bg-slate-800/50 border border-white dark:border-slate-700">
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-1">路由期望值</p>
                                <p class="text-sm font-black text-indigo-500" id="stat-prob-${p.id}">0.00%</p>
                            </div>
                            <div class="p-3 rounded-2xl bg-slate-100/50 dark:bg-slate-800/50 border border-white dark:border-slate-700">
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-1">中位延迟 P50</p>
                                <p class="text-sm font-black text-slate-600 dark:text-slate-300" id="stat-latency-${p.id}">-</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1.5">${models}${p.models && p.models.length > 3 ? `<span class="text-[9px] text-slate-400 font-bold ml-1">+${p.models.length - 3}</span>` : ''}</div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex gap-2">
                             <button onclick="manualResync('${p.id}')" title="同步节点" class="w-8 h-8 rounded-lg flex items-center justify-center bg-indigo-50 text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all">
                                <i class="fa-solid fa-sync text-xs"></i>
                             </button>
                        </div>
                        <button onclick="deleteProvider('${p.id}')" class="text-[10px] font-bold text-red-400 hover:text-red-600 transition-colors">退役节点</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) { console.error('网关渲染失败', e); }
    }

    window.addEventListener('cosmic-event', (e) => {
        const payload = e.detail;
        if (payload.type === 'init' || payload.type === 'metrics_update') {
            updateHeaderStats(payload.data);
            if (payload.data.usage && payload.data.usage.providers) {
                Object.entries(payload.data.usage.providers).forEach(([pid, stats]) => {
                    const probEl = document.getElementById(`stat-prob-${pid}`);
                    if (probEl) probEl.innerText = `${((stats.count / (payload.data.counters.total_requests || 1)) * 100).toFixed(1)}%`;
                });
            }
        }
        if (payload.type === 'error') {
            const feed = document.getElementById('errorFeed');
            if (feed.querySelector('p.italic')) feed.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/50 flex items-start gap-3 animate-bounce-short';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-xl bg-red-100 text-red-600 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-bolt"></i></div>
                <div>
                   <p class="text-[10px] font-black text-red-800 dark:text-red-400 uppercase tracking-tighter">${payload.data.provider}</p>
                   <p class="text-[11px] font-medium text-red-600 dark:text-red-300">${payload.data.msg}</p>
                </div>
            `;
            feed.prepend(div);
            if (feed.children.length > 5) feed.lastElementChild.remove();
        }
    });

    document.getElementById('addProviderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 正在部署...';
        try {
            const payload = {
                name: document.getElementById('name').value,
                baseUrl: document.getElementById('baseUrl').value,
                apiKey: document.getElementById('apiKey').value,
                modelBlacklist: document.getElementById('modelBlacklist').value.split(',').filter(Boolean)
            };
            const res = await fetch('/admin/providers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (data.success) {
                e.target.reset();
                window.stream.showToast('节点已成功接入矩阵', 'success');
                renderProviderGrid();
            } else {
                window.stream.showToast('部署失败: ' + data.error, 'error');
            }
        } catch (err) {
            window.stream.showToast('网络同步失败', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    window.deleteProvider = async (id) => {
        if (!confirm('确认退役节点：此操作将断开与该供应商的矩阵连接。')) return;
        await fetch(`/admin/providers/${id}`, { method: 'DELETE' });
        window.stream.showToast('节点已退役', 'info');
        renderProviderGrid();
    };

    window.manualResync = async (id) => {
        await fetch(`/admin/providers/${id}/resync`, { method: 'POST' });
        window.stream.showToast('重同步已触发', 'info');
        renderProviderGrid();
    };

    window.resyncAll = () => {
        window.stream.showToast('全局矩阵同步已启动', 'info');
        renderProviderGrid();
    };

    window.addEventListener('load', () => { initCharts(); renderProviderGrid(); setInterval(renderProviderGrid, 30000); });
    window.addEventListener('resize', () => { if (chart) chart.resize(); });
</script>
{% endblock %}